{"Name":"Sanitize Prompt","Description":"","Script":"from SiemplifyAction import SiemplifyAction\nfrom SiemplifyUtils import unix_now, convert_unixtime_to_datetime, output_handler\nfrom ScriptResult import EXECUTION_STATE_COMPLETED, EXECUTION_STATE_FAILED,EXECUTION_STATE_TIMEDOUT\nimport google.auth.transport.requests\nfrom google.oauth2 import service_account\nimport json\nimport requests\nfrom google.auth import impersonated_credentials\n\n\n@output_handler\ndef main():\n    siemplify = SiemplifyAction()\n\n    template_id = siemplify.extract_configuration_param('Integration',\"Template ID\")\n    region = siemplify.extract_configuration_param('Integration',\"Region\")\n    project_id = siemplify.extract_configuration_param('Integration',\"Project ID\")\n    prompt = siemplify.extract_action_param(\"Prompt\", print_value=True)\n    workload_email = siemplify.extract_configuration_param('Integration',\"Workload Identity Email\", print_value=True)\n    sa_json = siemplify.extract_configuration_param('Integration',\"Service Account JSON\")\n    if sa_json is not None:\n        sa_json = json.loads(sa_json)\n    \n    # Default to trying to use the workload identity for auth\n    if workload_email is not None:\n        siemplify.LOGGER.info(\"Auth via Workload Identity E-mail\")\n        source_credentials, project = google.auth.default(\n            scopes=['https://www.googleapis.com/auth/cloud-platform']\n        )\n        credentials = impersonated_credentials.Credentials(\n            source_credentials=source_credentials,\n            target_principal=workload_email,\n            target_scopes=['https://www.googleapis.com/auth/cloud-platform'],\n            lifetime=300\n        )\n        request = google.auth.transport.requests.Request()\n        credentials.refresh(request)\n    else:\n        siemplify.LOGGER.info(\"Auth via Service Account JSON\")\n        credentials = service_account.Credentials.from_service_account_info(\n        sa_json, scopes=[\"https://www.googleapis.com/auth/cloud-platform\"]\n        )\n        request = google.auth.transport.requests.Request()\n        credentials.refresh(request)\n    hd = {\n        \"Authorization\": \"Bearer \" + credentials.token,\n        \"Content-Type\": \"application/json\"\n    }\n    body = { \n        \"user_prompt_data\" : { \n            \"text\": prompt \n        } \n    }\n    URL = f\"https://modelarmor.{region}.rep.googleapis.com/v1/projects/{project_id}/locations/{region}/templates/{template_id}:sanitizeUserPrompt\"\n    req = requests.post(URL, headers=hd, json=body)\n    siemplify.LOGGER.info(req.text)\n\n    status = EXECUTION_STATE_COMPLETED\n    output_message = \"Succesfully executed.\"\n    siemplify.result.add_result_json(req.json())\n    result_value = None\n\n    siemplify.LOGGER.info(\"\\n  status: {}\\n  result_value: {}\\n  output_message: {}\".format(status,result_value, output_message))\n    siemplify.end(output_message, result_value, status)\n\n\nif __name__ == \"__main__\":\n    main()\n","IntegrationIdentifier":"Unofficial GCP Model Armor","ScriptResultName":"ScriptResult","DynamicResultsMetadata":[{"ResultName":"JsonResult","ResultExample":"{}","ShowResult":true}],"Creator":"036fe879-4c16-461e-b6d9-b1c552806fa0","IsEnabled":true,"IsCustom":true,"IsSystem":false,"Version":11.0,"TimeoutSeconds":600,"IsAsync":false,"AsyncPollingIntervalInSeconds":3600,"TotalIntervalTimeoutForAsyncInSeconds":86400,"Parameters":[{"CustomActionId":0,"IsMandatory":true,"DefaultValue":"Hello world!","Description":"Prompt being sent to the LLM","Name":"Prompt","Value":"Hello world!","Type":0,"OptionalValues":null,"OptionalValuesJson":null}],"DefaultResultValue":"","PythonVersion":"None","SimulationData":{"Entities":null},"SimulationDataJson":null}